---
import 'bulma/css/bulma.min.css';
import '../styles/_global.scss';


import timeReportItems from '../config/time-report-items.json';
import TimeReportCheckboxGroup from '../components/TimeReportCheckboxGroup.astro';

const monthKey = '2026-01';
const items = timeReportItems[monthKey];

// Special-ersättnigar (läger, tävling)
// Heldag: 1000 kr
// Halvdag: 500 kr
// Övernattning: 300 kr
---

<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Tidrapport</title>
  </head>
  <body>
    <section class="section">
      <div class="container is-max-desktop">
        <h1 class="title">Arbetad tid i Alvesta Simsällskap</h1>
        <h2 class="subtitle">Månadsrapport januari 2026</h2>
        <form method="POST" action="/api/send-time-report" x-data="formHandler" x-on:submit.prevent="handleSubmit" @timereportupdate.window="updateTotalTime()">
          <div class="box mt-5">
            <div class="field">
              <label class="label">Namn</label>
              <div class="control">
              <input class="input" type="text" placeholder="Namn" name="namn" required autocomplete="name" />
              </div>
            </div>
            <div class="field">
              <label class="label">E-post (kopia skickas hit)</label>
              <div class="control">
              <input class="input" type="email" placeholder="E-postadress" name="email" required autocomplete="email" />
              </div>
            </div>
          </div>

          <div class="box mt-5" x-data="{ open: false }">
            <h2 class="subtitle my-0" @click="open = !open" style="cursor:pointer;">
              Simskola
              <span x-text="open ? '▲' : '▼'" class="ml-2 is-size-6"></span>
            </h2>
            <div class="mt-4" x-show="open" x-transition>
              <TimeReportCheckboxGroup section="simskola" items={items.simskola} />
            </div>
          </div>

          <div class="box mt-5" x-data="{ open: false }">
            <h2 class="subtitle my-0" @click="open = !open" style="cursor:pointer;">
              Träningsgrupper
              <span x-text="open ? '▲' : '▼'" class="ml-2 is-size-6"></span>
            </h2>
            <div x-show="open" x-transition>
              <div class="columns mt-2">
                <div class="column">
                  <TimeReportCheckboxGroup section="tavling-a" items={items.tavlingA} label="Tävling A" />
                </div>
                <div class="column">
                  <TimeReportCheckboxGroup section="tavling-b" items={items.tavlingB} label="Tävling B" />
                </div>
                <div class="column">
                  <TimeReportCheckboxGroup section="teknik" items={items.teknik} label="Teknik" />
                </div>
                <div class="column">
                  <TimeReportCheckboxGroup section="masters" items={items.masters} label="Masters" />
                </div>
                <div class="column">
                  <TimeReportCheckboxGroup section="vuxencrawl" items={items.vuxencrawl} label="Vuxencrawl" />
                </div>
              </div>
            </div>
          </div>
          <div class="box mt-5" id="timereport-total-box">
            <span>Total tid:</span>
            <span x-text="totalTime"></span>
          </div>       
          <div class="box mt-5">
            <div class="columns">
              <div class="column">
                <div class="field">
                  <label class="label">Kommentarer</label>
                  <div class="control">
                    <textarea class="textarea" rows="3" placeholder="Eventuella kommentarer" name="kommentarer"></textarea>
                  </div>
                  <p class="help">Eventuella kommentarer för tillfällena ovan, annan extra arbetstid eller utlägg</p>
                </div>
              </div>
              <div class="column">
                <div class="field">
                  <label class="label">Milersättning (km)</label>
                  <div class="control">
                    <input
                      class="input"
                      type="number"
                      name="milersattning"
                      min="1"
                      max="500"
                      placeholder="Ange kilometer"
                      style="max-width: 150px;"
                    />
                  </div>
                  <p class="help">Ange antal kilometer (1-500)</p>
                </div>
              </div>
            </div>
          </div>
          <div class="box mt-5" x-data="{ open: false, files: [{ id: Date.now(), file: null, desc: '' }] }">
            <h2 class="subtitle my-0" @click="open = !open" style="cursor:pointer;">
              Utlägg
              <span x-text="open ? '▲' : '▼'" class="ml-2 is-size-6"></span>
            </h2>
            <div class="mt-4" x-show="open" x-transition>
              <template x-for="(item, idx) in files" :key="item.id">
                <div class="box mb-3">
                  <div class="field">
                    <label class="label">Fil (pdf, jpg, png)</label>
                    <div class="control">
                      <input type="file" accept=".pdf,.png,.jpg,.jpeg" :name="`utlagg_file_${item.id}`" required />
                    </div>
                  </div>
                  <div class="field">
                    <label class="label">Beskrivning</label>
                    <div class="control">
                      <input type="text" class="input" :name="`utlagg_desc_${item.id}`" placeholder="Beskrivning av utlägg" required />
                    </div>
                  </div>
                  <button class="button is-small is-danger mt-2" type="button" @click="files.splice(idx, 1)" x-show="files.length > 1">Ta bort</button>
                </div>
              </template>
              <button class="button is-link is-light" type="button" @click="files.push({ id: Date.now() + Math.random(), file: null, desc: '' })">Lägg till fil</button>
            </div>
          </div>          
          <div class="field">
            <div class="cf-turnstile" data-sitekey="0x4AAAAAACV0HK5DAZEGpQip" data-theme="light" data-callback="onTurnstileSuccess"></div>
          </div>
          <div class="field">
            <div class="control">
              <button id="submitBtn" class="button is-link is-primary" type="submit" disabled>Skicka in tidrapport</button>
            </div>
          </div>
        </form>
      </div>
    </section>
    <script is:inline>
      document.addEventListener('alpine:init', () => {
        Alpine.data('formHandler', () => ({          
          totalTime: '0',
          updateTotalTime() {
            let totalH = 0, totalM = 0;
            let totalFullDay = 0;
            let totalHalfDay = 0;

            document.querySelectorAll('input[type=checkbox][data-h][data-m]:checked').forEach(cb => {
              const h = parseInt(cb.getAttribute('data-h')) || 0;
              const m = parseInt(cb.getAttribute('data-m')) || 0;
              
              if (h === 10) { totalHalfDay += 1; return; }
              if (h === 20) { totalFullDay += 1; return; }              

              totalH += h;
              totalM += m;
            });

            totalH += Math.floor(totalM / 60);
            totalM = totalM % 60;

            let totalTimeReported = `${totalH}:${totalM < 10 ? '0' : ''}${totalM}`;
            if (totalFullDay > 0) {
              totalTimeReported += `. Heldag: ${totalFullDay}`;
            }
            if (totalHalfDay > 0) {
              totalTimeReported += `. Halvdag: ${totalHalfDay}`;
            }

            this.totalTime = totalTimeReported;
          },
          async handleSubmit(e) {
            const form = e.target;
            const formData = new FormData(form);
            const res = await fetch(form.action, { method: 'POST', body: formData });
            if (res.ok) {
              window.location.href = '/tack';
            } else {
              alert('Något gick fel. Försök igen.');
            }
          }
        }));

        // Initial calculation on page load
        window.addEventListener('DOMContentLoaded', () => {
          document.querySelector('form[x-data]')?.__x?.$data?.updateTotalTime?.();
        });
      });
    </script>
    <script is:inline>
      // Enable submit button when Turnstile is solved
      window.onTurnstileSuccess = function() {
        document.getElementById('submitBtn').disabled = false;
      };
    </script>
    <script is:inline src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  </body>
</html>